<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trader Dashboard - Payroll Management</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        const API_BASE = 'http://localhost:4000';

        function authHeaders(){ const t=localStorage.getItem('authToken'); return { 'Content-Type':'application/json', 'Authorization': `Bearer ${t}` }; }
        function authHeadersNoContent(){ const t=localStorage.getItem('authToken'); return { 'Authorization': `Bearer ${t}` }; }
        function getRole(){ return (localStorage.getItem('userRole')||'').toLowerCase(); }
        function getUsername(){ return localStorage.getItem('username')||''; }

        function checkAuth(){
            const token = localStorage.getItem('authToken');
            const role = getRole();
            const username = getUsername();
            if(!token || !role || !username){ window.location.href='login.html'; return; }
            if(role !== 'trader' && role !== 'admin'){
                alert('Access denied. Trader privileges required.');
                window.location.href = role==='hr' || role==='admin' ? 'hr-dashboard.html' : 'employee-profile.html';
                return;
            }
            document.getElementById('currentUser').innerHTML = `<span>${username}</span><span class="role-badge">${role==='admin'?'Admin':'Trader'}</span>`;
            loadForecast();
        }

        async function loadForecast(){
            const cards = {
                totalValueUsd: document.getElementById('cardTotalValue'),
                realizedGainsYtdUsd: document.getElementById('cardRealized'),
                unrealizedGainsUsd: document.getElementById('cardUnrealized'),
                estimatedTaxUsd: document.getElementById('cardTax')
            };
            const tbody = document.getElementById('holdingsBody');
            try{
                const r = await fetch(`${API_BASE}/api/trader/forecast`, { headers: authHeaders() });
                if(!r.ok) throw new Error('bad');
                const d = await r.json();
                cards.totalValueUsd.textContent = `$${d.totalValueUsd?.toLocaleString()||'0'}`;
                cards.realizedGainsYtdUsd.textContent = `$${d.realizedGainsYtdUsd?.toLocaleString()||'0'}`;
                cards.unrealizedGainsUsd.textContent = `$${d.unrealizedGainsUsd?.toLocaleString()||'0'}`;
                cards.estimatedTaxUsd.textContent = `$${d.estimatedTaxUsd?.toLocaleString()||'0'}`;
                const rows = (d.holdings||[]).map(h=>`
                    <tr>
                        <td>${h.symbol}</td>
                        <td>${h.amount}</td>
                        <td>$${(h.priceUsd||0).toLocaleString()}</td>
                        <td>$${(h.valueUsd||0).toLocaleString()}</td>
                    </tr>
                `).join('');
                tbody.innerHTML = rows || `<tr><td colspan="4" class="no-data"><i class=\"fas fa-inbox\"></i> No holdings.</td></tr>`;
            }catch{
                tbody.innerHTML = `<tr><td colspan="4" class="no-data"><i class=\"fas fa-triangle-exclamation\"></i> Failed to load data.</td></tr>`;
            }
        }

        async function onImportCsv(event){
            event.preventDefault();
            const input = document.getElementById('csvFile');
            if(!input.files || input.files.length===0){ alert('Choose a CSV file.'); return; }
            try{
                const fd = new FormData();
                fd.append('file', input.files[0]);
                const previewResp = await fetch(`${API_BASE}/api/trader/import/csv?dryRun=1`, { method:'POST', headers: authHeadersNoContent(), body: fd });
                if(!previewResp.ok){ const er=await previewResp.json().catch(()=>({error:'Preview failed'})); alert(er.error||'Preview failed'); return; }
                const preview = await previewResp.json();
                openPreviewModal(preview, input.files[0]);
            }catch{
                alert('Import failed. Try again.');
            }
        }

        function openPreviewModal(preview, file){
            window._pendingImportFile = file;
            window._pendingPreview = preview;
            document.getElementById('previewCounts').innerHTML = `
                <strong>Valid rows:</strong> ${preview.totalValid} &nbsp;|&nbsp; <strong>Errors:</strong> ${preview.totalErrors}
            `;
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = (preview.rows||[]).map(r=>`
                <tr>
                    <td>${r.row}</td>
                    <td>${r.symbol}</td>
                    <td>${r.amount}</td>
                    <td>${r.price ?? ''}</td>
                    <td>${r.type}</td>
                    <td>${new Date(r.timestamp).toLocaleString()}</td>
                </tr>
            `).join('');
            const errBox = document.getElementById('previewErrors');
            if((preview.errors||[]).length === 0){ errBox.innerHTML = '<div class="small muted">No errors.</div>'; }
            else {
                const items = preview.errors.slice(0,100).map(e=>`<li>Row ${e.row}: ${e.message}</li>`).join('');
                errBox.innerHTML = `<ul class="error-list">${items}</ul>`;
            }
            const btn = document.getElementById('commitImportBtn');
            btn.disabled = (preview.totalValid||0) === 0;
            document.getElementById('importPreviewModal').style.display = 'block';
        }

        async function commitImport(){
            if(!window._pendingImportFile){ alert('No file to import.'); return; }
            try{
                const fd = new FormData();
                fd.append('file', window._pendingImportFile);
                const importResp = await fetch(`${API_BASE}/api/trader/import/csv`, { method:'POST', headers: authHeadersNoContent(), body: fd });
                if(!importResp.ok){ const er=await importResp.json().catch(()=>({error:'Import failed'})); alert(er.error||'Import failed'); return; }
                const done = await importResp.json();
                closePreviewModal();
                alert(`Imported ${done.imported} transactions.`);
                loadForecast();
            }catch{
                alert('Import failed. Try again.');
            }
        }

        function closePreviewModal(){
            window._pendingImportFile = null;
            window._pendingPreview = null;
            document.getElementById('importPreviewModal').style.display = 'none';
            document.getElementById('previewTableBody').innerHTML = '';
            document.getElementById('previewErrors').innerHTML = '';
        }

        function exportPdf(){ window.open(`${API_BASE}/api/trader/report.pdf?ts=${Date.now()}`, '_blank'); }

        function logout(){
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            window.location.href='login.html';
        }

        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-coins"></i> Trader Portal</h1>
            <div class="user-info">
                <span id="currentUser">Loading...</span>
                <button onclick="logout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>
    <div class="container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-coins"></i>
                <span>Trader Portal</span>
            </div>
            <ul class="nav-links">
                <li class="active">
                    <a href="trader-dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="employee-profile.html">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
        <main class="main-content">
            <div class="page-header">
                <h2><i class="fas fa-chart-line"></i> Crypto Overview</h2>
                <p>Import wallet transactions, view holdings, and export tax reports.</p>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Total Portfolio Value</div>
                    <div class="card-value" id="cardTotalValue">$0</div>
                </div>
                <div class="card">
                    <div class="card-title">Realized Gains (YTD)</div>
                    <div class="card-value" id="cardRealized">$0</div>
                </div>
                <div class="card">
                    <div class="card-title">Unrealized Gains</div>
                    <div class="card-value" id="cardUnrealized">$0</div>
                </div>
                <div class="card">
                    <div class="card-title">Estimated Tax</div>
                    <div class="card-value" id="cardTax">$0</div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-wallet"></i> Holdings</h3>
                    <div>
                        <button class="secondary-btn" onclick="loadForecast()"><i class="fas fa-sync-alt"></i> Refresh</button>
                        <button class="primary-btn" onclick="exportPdf()"><i class="fas fa-file-pdf"></i> Export Tax PDF</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Amount</th>
                                <th>Price (USD)</th>
                                <th>Value (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-file-import"></i> Import Transactions</h3>
                </div>
                <form onsubmit="onImportCsv(event)" class="password-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="csvFile">Upload CSV</label>
                            <input type="file" id="csvFile" accept=".csv" required>
                        </div>
                    </div>
                    <button type="submit" class="primary-btn"><i class="fas fa-upload"></i> Preview</button>
                </form>
            </div>
        </main>
    </div>
    <footer>
        <p>&copy; 2025 PayrollPro by Aaron | Trader Portal</p>
    </footer>

    <div id="importPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Import Preview</h3>
                <span class="close" onclick="closePreviewModal()">&times;</span>
            </div>
            <div class="content-section">
                <div id="previewCounts" class="hint"></div>
                <div class="table-container" style="max-height: 300px; overflow:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Asset</th>
                                <th>Amount</th>
                                <th>Price</th>
                                <th>Type</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-section">
                <div class="section-header">
                    <h4><i class="fas fa-triangle-exclamation"></i> Errors</h4>
                </div>
                <div id="previewErrors" class="error" style="white-space: normal;"></div>
            </div>
            <div class="modal-actions" style="display:flex; gap:0.5rem; justify-content:flex-end;">
                <button class="secondary-btn" onclick="closePreviewModal()">Cancel</button>
                <button id="commitImportBtn" class="primary-btn" onclick="commitImport()"><i class="fas fa-check"></i> Import</button>
            </div>
        </div>
    </div>
</body>
</html>
