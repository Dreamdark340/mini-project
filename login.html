<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Payroll Management</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    function showError(msg){ const el=document.getElementById('errorBox'); el.textContent=msg; el.style.display='block'; }
    function clearError(){ const el=document.getElementById('errorBox'); el.style.display='none'; el.textContent=''; }

    // Demo users data
    const demoUsers = {
      'aaron': { password: 'password', role: 'employee', fullName: 'Aaron Employee' },
      'hr1': { password: 'password', role: 'hr', fullName: 'Harper HR' },
      'admin': { password: 'admin123', role: 'admin', fullName: 'Alex Admin' }
    };

    function onDomReady(){
      document.getElementById('loginForm').addEventListener('submit', onLoginSubmit);
      document.getElementById('twoFAForm').addEventListener('submit', onTwoFASubmit);
      document.getElementById('useRecoveryBtn').addEventListener('click', ()=>{
        document.getElementById('twoFACode').value='';
        document.getElementById('recoveryCode').parentElement.style.display='block';
        document.getElementById('twoFABadge').textContent='Using recovery code';
      });
      document.getElementById('backToCodeBtn').addEventListener('click', ()=>{
        document.getElementById('recoveryCode').value='';
        document.getElementById('recoveryCode').parentElement.style.display='none';
        document.getElementById('twoFABadge').textContent='Enter 6-digit code';
      });
      // Role switcher
      initRoleSwitcher();
      // File-based autofill
      initFileUpload();
      // Update API status
      document.getElementById('apiStatus').textContent='Frontend Only Mode';
      document.getElementById('apiStatus').className='status-badge warning';
    }

    let pendingUser = null;
    let rememberMe = false;

    function onLoginSubmit(e){
      e.preventDefault(); clearError();
      const username=(document.getElementById('username').value||'').trim();
      const password=document.getElementById('password').value||'';
      rememberMe=document.getElementById('remember').checked;
      if(!username || !password){ showError('Enter username and password.'); return; }
      
      // Check demo users
      const user = demoUsers[username];
      if(!user || user.password !== password){
        showError('Invalid username or password.');
        return;
      }

      // Simulate 2FA check (all demo users have 2FA enabled)
      pendingUser = username;
      document.getElementById('loginForm').style.display='none';
      document.getElementById('twoFAStep').style.display='block';
      document.getElementById('twoFAUser').textContent=username;
      document.getElementById('recoveryCode').parentElement.style.display='none';
      document.getElementById('twoFACode').focus();
    }

    function onTwoFASubmit(e){
      e.preventDefault(); clearError();
      const username=pendingUser; 
      if(!username){ showError('Session expired. Try again.'); return; }
      
      const code=(document.getElementById('twoFACode').value||'').trim();
      const rec=(document.getElementById('recoveryCode').value||'').trim();
      
      // Simple validation - accept any 6-digit code or recovery code for demo
      let valid = false;
      if(code && code.length === 6 && /^\d{6}$/.test(code)){
        valid = true;
      } else if(rec && rec.length === 9 && rec.includes('-')){
        valid = true;
      }
      
      if(!valid){
        showError('Invalid 2FA verification.');
        return;
      }

      // Complete login
      const user = demoUsers[username];
      finalizeLogin(username, user);
    }

    function finalizeLogin(username, user){
      // Store user data in localStorage
      localStorage.setItem('userRole', user.role);
      localStorage.setItem('username', username);
      localStorage.setItem('fullName', user.fullName);
      if(rememberMe){ localStorage.setItem('rememberMe', '1'); } else { localStorage.removeItem('rememberMe'); }
      
      // Store login history
      const key=`loginHistory_${username}`; 
      const ua=navigator.userAgent; 
      const now=new Date().toISOString();
      const hist=JSON.parse(localStorage.getItem(key) || '[]'); 
      hist.unshift({ timestamp: now, ipAddress: 'Demo', device: ua, status: 'Success', location: 'Demo' }); 
      localStorage.setItem(key, JSON.stringify(hist.slice(0,50)));
      
      // Redirect based on role
      const role = user.role.toLowerCase();
      if(role === 'hr' || role === 'admin'){ 
        window.location.href='hr-dashboard.html'; 
      } else { 
        window.location.href='employee-dashboard.html'; 
      }
    }

    function initRoleSwitcher(){
      const select = document.getElementById('roleSelect');
      if(!select) return;
      select.addEventListener('change', ()=>{
        const v = select.value;
        if(v==='employee'){ document.getElementById('username').value='aaron'; document.getElementById('password').value='password'; }
        else if(v==='hr'){ document.getElementById('username').value='hr1'; document.getElementById('password').value='password'; }
        else if(v==='admin'){ document.getElementById('username').value='admin'; document.getElementById('password').value='admin123'; }
        else { document.getElementById('username').value=''; document.getElementById('password').value=''; }
      });
    }

    function initFileUpload(){
      const fileInput = document.getElementById('loginFile');
      if(fileInput){
        fileInput.addEventListener('change', async (e)=>{
          const file = e.target.files?.[0];
          if(!file) return;
          try{
            const txt = await file.text();
            const obj = JSON.parse(txt);
            const { username, password, role } = obj;
            if(username) document.getElementById('username').value = username;
            if(password) document.getElementById('password').value = password;
            if(role){
              const sel = document.getElementById('roleSelect');
              if(sel){ sel.value = role; sel.dispatchEvent(new Event('change')); }
            }
          }catch(err){
            alert('Invalid JSON file. Expected {"username":"","password":"","role":""}');
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', onDomReady);
  </script>
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card">
      <div class="auth-header">
        <div class="brand"><i class="fas fa-chart-line"></i> Payroll Management</div>
        <h1>Sign in to your account</h1>
        <div class="hint">Use role switcher below to autofill demo users. <span id="apiStatus" class="status-badge">Checking API...</span></div>
      </div>
      <div id="errorBox" class="error"></div>

      <!-- Step 1: Credentials -->
      <form id="loginForm">
        <div class="form-group">
          <label for="loginFile">Load credentials file</label>
          <input type="file" id="loginFile" accept="application/json">
        </div>
        <div class="form-group">
          <label for="roleSelect">Quick role</label>
          <select id="roleSelect">
            <option value="">Chooseâ€¦</option>
            <option value="employee">Employee (aaron/password)</option>
            <option value="hr">HR (hr1/password)</option>
            <option value="admin">Admin (admin/admin123)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="e.g. aaron" autocomplete="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Your password" autocomplete="current-password" required>
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" id="remember" style="width:auto;">
          <label for="remember" style="margin:0;">Remember this device</label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="primary-btn" style="width:100%; justify-content:center;">
            <i class="fas fa-right-to-bracket"></i> Continue
          </button>
        </div>
      </form>

      <!-- Step 2: 2FA -->
      <div id="twoFAStep" style="display:none;">
        <div class="divider"><span>Two-Factor Verification</span></div>
        <div class="hint">Account: <strong id="twoFAUser">user</strong></div>
        <form id="twoFAForm">
          <div class="form-group">
            <label>Authenticator Code <span id="twoFABadge" class="status-badge success" style="margin-left:6px;">Enter 6-digit code</span></label>
            <input type="text" id="twoFACode" placeholder="123456" inputmode="numeric" pattern="\d{6}" maxlength="6">
          </div>
          <div class="form-group" style="display:none;">
            <label>Recovery Code</label>
            <input type="text" id="recoveryCode" placeholder="XXXX-XXXX">
          </div>
          <div class="modal-actions" style="justify-content:space-between;">
            <div>
              <button type="button" id="useRecoveryBtn" class="secondary-btn small"><i class="fas fa-key"></i> Use recovery</button>
              <button type="button" id="backToCodeBtn" class="secondary-btn small"><i class="fas fa-rotate-left"></i> Use code</button>
            </div>
            <button type="submit" class="primary-btn"><i class="fas fa-lock-open"></i> Verify & Sign in</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</body>
</html>