<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Payroll Management</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    const API_BASE = 'http://localhost:4000';
    function generateId(prefix='id'){ return `${prefix}_${Math.random().toString(36).slice(2)}_${Date.now().toString(36)}`; }
    function getSessions(u){ return []; }
    function setSessions(u,s){}
    function getSecurity(u){ return { twoFAEnabled: true }; }
    function showError(msg){ const el=document.getElementById('errorBox'); el.textContent=msg; el.style.display='block'; }
    function clearError(){ const el=document.getElementById('errorBox'); el.style.display='none'; el.textContent=''; }

    function onDomReady(){
      document.getElementById('loginForm').addEventListener('submit', onLoginSubmit);
      document.getElementById('twoFAForm').addEventListener('submit', onTwoFASubmit);
      document.getElementById('useRecoveryBtn').addEventListener('click', ()=>{
        document.getElementById('twoFACode').value='';
        document.getElementById('recoveryCode').parentElement.style.display='block';
        document.getElementById('twoFABadge').textContent='Using recovery code';
      });
      document.getElementById('backToCodeBtn').addEventListener('click', ()=>{
        document.getElementById('recoveryCode').value='';
        document.getElementById('recoveryCode').parentElement.style.display='none';
        document.getElementById('twoFABadge').textContent='Enter 6-digit code';
      });
    }

    let pendingUser = null;
    let rememberMe = false;

    async function onLoginSubmit(e){
      e.preventDefault(); clearError();
      const username=(document.getElementById('username').value||'').trim();
      const password=document.getElementById('password').value||'';
      rememberMe=document.getElementById('remember').checked;
      if(!username || !password){ showError('Enter username and password.'); return; }
      // Call backend
      try{
        const resp = await fetch(`${API_BASE}/api/auth/login`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username, password, userAgent: navigator.userAgent }) });
        if(!resp.ok){ showError('Invalid username or password.'); return; }
        const data = await resp.json();
        pendingUser=username;
        if(data.twoFARequired){
          document.getElementById('loginForm').style.display='none';
          document.getElementById('twoFAStep').style.display='block';
          document.getElementById('twoFAUser').textContent=username;
          document.getElementById('recoveryCode').parentElement.style.display='none';
          document.getElementById('twoFACode').focus();
        } else {
          finalizeLoginWithToken(username, data);
        }
      }catch(err){ showError('Network error. Try again.'); }
    }

    async function onTwoFASubmit(e){
      e.preventDefault(); clearError();
      const username=pendingUser; if(!username){ showError('Session expired. Try again.'); return; }
      const code=(document.getElementById('twoFACode').value||'').trim();
      const rec=(document.getElementById('recoveryCode').value||'').trim();
      try{
        const resp = await fetch(`${API_BASE}/api/auth/2fa`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username, code: code || undefined, recoveryCode: rec || undefined, userAgent: navigator.userAgent }) });
        if(!resp.ok){ showError('Invalid 2FA verification.'); return; }
        const data = await resp.json();
        finalizeLoginWithToken(username, data);
      }catch(err){ showError('Network error. Try again.'); }
    }

    function finalizeLoginWithToken(username, data){
      const { token, sessionId, user } = data;
      if(!token){ showError('Login failed.'); return; }
      localStorage.setItem('authToken', token);
      localStorage.setItem('userRole', user?.role || 'employee');
      localStorage.setItem('username', user?.username || username);
      if(sessionId) localStorage.setItem('currentSessionId', sessionId);
      if(rememberMe){ localStorage.setItem('rememberMe', '1'); } else { localStorage.removeItem('rememberMe'); }
      const key=`loginHistory_${username}`; const ua=navigator.userAgent; const now=new Date().toISOString();
      const hist=JSON.parse(localStorage.getItem(key) || '[]'); hist.unshift({ timestamp: now, ipAddress: 'Unknown', device: ua, status: 'Success', location: 'Unknown' }); localStorage.setItem(key, JSON.stringify(hist.slice(0,50)));
      const role = (user?.role||'employee').toLowerCase();
      if(role === 'admin'){ window.location.href='admin-dashboard.html'; }
      else if(role === 'hr'){ window.location.href='hr-dashboard.html'; }
      else { window.location.href='employee-profile.html'; }
    }

    document.addEventListener('DOMContentLoaded', onDomReady);
  </script>
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card">
      <div class="auth-header">
        <div class="brand"><i class="fas fa-chart-line"></i> Payroll Management</div>
        <h1>Sign in to your account</h1>
        <div class="hint">Use demo password: <strong>password</strong></div>
      </div>
      <div id="errorBox" class="error"></div>

      <!-- Step 1: Credentials -->
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="e.g. aaron" autocomplete="username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Your password" autocomplete="current-password" required>
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" id="remember" style="width:auto;">
          <label for="remember" style="margin:0;">Remember this device</label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="primary-btn" style="width:100%; justify-content:center;">
            <i class="fas fa-right-to-bracket"></i> Continue
          </button>
        </div>
      </form>

      <!-- Step 2: 2FA -->
      <div id="twoFAStep" style="display:none;">
        <div class="divider"><span>Two-Factor Verification</span></div>
        <div class="hint">Account: <strong id="twoFAUser">user</strong></div>
        <form id="twoFAForm">
          <div class="form-group">
            <label>Authenticator Code <span id="twoFABadge" class="status-badge success" style="margin-left:6px;">Enter 6-digit code</span></label>
            <input type="text" id="twoFACode" placeholder="123456" inputmode="numeric" pattern="\d{6}" maxlength="6">
          </div>
          <div class="form-group" style="display:none;">
            <label>Recovery Code</label>
            <input type="text" id="recoveryCode" placeholder="XXXX-XXXX">
          </div>
          <div class="modal-actions" style="justify-content:space-between;">
            <div>
              <button type="button" id="useRecoveryBtn" class="secondary-btn small"><i class="fas fa-key"></i> Use recovery</button>
              <button type="button" id="backToCodeBtn" class="secondary-btn small"><i class="fas fa-rotate-left"></i> Use code</button>
            </div>
            <button type="submit" class="primary-btn"><i class="fas fa-lock-open"></i> Verify & Sign in</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</body>
</html>

