<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Payroll Management</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        // Base32 RFC 4648 (no padding) encoder/decoder
        const Base32 = (() => {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            const charToVal = Object.fromEntries([...alphabet].map((c,i)=>[c,i]));
            function encode(bytes) {
                let bits = 0, value = 0, output = '';
                for (let i = 0; i < bytes.length; i++) {
                    value = (value << 8) | bytes[i];
                    bits += 8;
                    while (bits >= 5) {
                        output += alphabet[(value >>> (bits - 5)) & 31];
                        bits -= 5;
                    }
                }
                if (bits > 0) {
                    output += alphabet[(value << (5 - bits)) & 31];
                }
                return output;
            }
            function decode(str) {
                const clean = str.toUpperCase().replace(/=+$/,'');
                let bits = 0, value = 0;
                const output = [];
                for (let i = 0; i < clean.length; i++) {
                    const ch = clean[i];
                    const val = charToVal[ch];
                    if (val === undefined) continue;
                    value = (value << 5) | val;
                    bits += 5;
                    if (bits >= 8) {
                        output.push((value >>> (bits - 8)) & 255);
                        bits -= 8;
                    }
                }
                return new Uint8Array(output);
            }
            return { encode, decode };
        })();

        // Utility: random bytes and id
        function getRandomBytes(length) {
            const bytes = new Uint8Array(length);
            crypto.getRandomValues(bytes);
            return bytes;
        }
        function generateId(prefix = 'id') {
            const now = Date.now().toString(36);
            const rand = Base32.encode(getRandomBytes(10)).slice(0, 12).toLowerCase();
            return `${prefix}_${now}_${rand}`;
        }

        // TOTP (HMAC-SHA1, 30s period, 6 digits) using Web Crypto
        async function generateTOTPCode(base32Secret, timeStepSeconds = 30, digits = 6) {
            const keyBytes = Base32.decode(base32Secret);
            const counter = Math.floor(Date.now() / 1000 / timeStepSeconds);
            const counterBytes = new ArrayBuffer(8);
            const view = new DataView(counterBytes);
            // Big-endian 64-bit
            view.setUint32(0, Math.floor(counter / 0x100000000));
            view.setUint32(4, counter >>> 0);
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBytes,
                { name: 'HMAC', hash: 'SHA-1' },
                false,
                ['sign']
            );
            const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, counterBytes));
            const offset = hmac[hmac.length - 1] & 0x0f;
            const codeInt = ((hmac[offset] & 0x7f) << 24) | (hmac[offset + 1] << 16) | (hmac[offset + 2] << 8) | hmac[offset + 3];
            const mod = 10 ** digits;
            const code = (codeInt % mod).toString().padStart(digits, '0');
            return code;
        }
        async function verifyTOTPCode(base32Secret, userCode) {
            // Allow small time drift: check current, previous, next window
            const digits = userCode.length;
            const windowOffsets = [0, -1, 1];
            const now = Math.floor(Date.now() / 1000);
            for (const off of windowOffsets) {
                const code = await generateTOTPAtTime(base32Secret, now + off * 30, 30, digits);
                if (code === userCode) return true;
            }
            return false;
        }
        async function generateTOTPAtTime(base32Secret, epochSeconds, step, digits) {
            const keyBytes = Base32.decode(base32Secret);
            const counter = Math.floor(epochSeconds / step);
            const counterBytes = new ArrayBuffer(8);
            const view = new DataView(counterBytes);
            view.setUint32(0, Math.floor(counter / 0x100000000));
            view.setUint32(4, counter >>> 0);
            const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
            const hmac = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, counterBytes));
            const offset = hmac[hmac.length - 1] & 0x0f;
            const codeInt = ((hmac[offset] & 0x7f) << 24) | (hmac[offset + 1] << 16) | (hmac[offset + 2] << 8) | hmac[offset + 3];
            const mod = 10 ** digits;
            return (codeInt % mod).toString().padStart(digits, '0');
        }

        // Recovery codes
        function generateRecoveryCodes(count = 10) {
            const codes = [];
            for (let i = 0; i < count; i++) {
                const part1 = Base32.encode(getRandomBytes(4)).slice(0, 4);
                const part2 = Base32.encode(getRandomBytes(4)).slice(0, 4);
                codes.push(`${part1}-${part2}`);
            }
            return codes;
        }

        // Global state
        const API_BASE = 'http://localhost:4000';
        let currentProfile = {};
        function authHeaders(){ const t=localStorage.getItem('authToken'); return { 'Content-Type':'application/json', 'Authorization': `Bearer ${t}` }; }

        function getUsername() { return localStorage.getItem('username'); }
        function profileKey(username) { return `profile_${username}`; }
        function securityKey(username) { return `security_${username}`; }
        function sessionsKey(username) { return `sessions_${username}`; }

        function getSecurityState(username) {
            const raw = localStorage.getItem(securityKey(username));
            return raw ? JSON.parse(raw) : { twoFAEnabled: false, twoFASecret: null, recoveryCodes: [] };
        }
        function setSecurityState(username, state) {
            localStorage.setItem(securityKey(username), JSON.stringify(state));
        }

        // Sessions helpers
        function getSessions(username) {
            const raw = localStorage.getItem(sessionsKey(username));
            return raw ? JSON.parse(raw) : [];
        }
        function setSessions(username, sessions) {
            localStorage.setItem(sessionsKey(username), JSON.stringify(sessions));
        }
        function upsertCurrentSession(username) {
            let currentSessionId = localStorage.getItem('currentSessionId');
            const ua = navigator.userAgent;
            let sessions = getSessions(username);
            const nowIso = new Date().toISOString();
            if (!currentSessionId) {
                currentSessionId = generateId('sess');
                localStorage.setItem('currentSessionId', currentSessionId);
                sessions.push({
                    id: currentSessionId,
                    createdAt: nowIso,
                    lastActiveAt: nowIso,
                    userAgent: ua,
                    device: extractDeviceFromUA(ua),
                    ipAddress: 'Unknown',
                    location: 'Unknown',
                    isCurrent: true
                });
            } else {
                sessions = sessions.map(s => s.id === currentSessionId ? { ...s, lastActiveAt: nowIso, isCurrent: true } : { ...s, isCurrent: false });
            }
            setSessions(username, sessions);
        }
        function extractDeviceFromUA(ua) {
            try {
                if (/Android/i.test(ua)) return 'Android';
                if (/iPhone|iPad|iPod/i.test(ua)) return 'iOS';
                if (/Windows/i.test(ua)) return 'Windows';
                if (/Macintosh/i.test(ua)) return 'macOS';
                if (/Linux/i.test(ua)) return 'Linux';
            } catch {}
            return 'Unknown Device';
        }

        // Check authentication and role
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            const username = localStorage.getItem('username');
            
            if (!token || !userRole || !username) {
                window.location.href = 'login.html';
                return;
            }
            
            if (userRole !== 'employee') {
                alert('Access denied. Employee privileges required.');
                window.location.href = 'login.html';
                return;
            }
            
            document.body.classList.add('employee-theme');
            document.getElementById('currentUser').innerHTML = `
                <span>${username}</span>
                <span class="role-badge">Employee</span>
            `;

            // Ensure session exists and mark current
            upsertCurrentSession(username);
            
            loadProfileData();
            loadLoginHistory();
            refreshSecurityUI();
        }

        // Load profile data
        async function loadProfileData() {
            const username = getUsername();
            try{
                const resp = await fetch(`${API_BASE}/api/profile`, { headers: authHeaders() });
                if(!resp.ok) throw new Error('Failed');
                const p = await resp.json();
                currentProfile = {
                    name: p.fullName || username,
                    username: p.username || username,
                    email: p.email || `${username}@company.com`,
                    phone: p.phone || '+1 (555) 123-4567',
                    department: p.department || 'Operations',
                    role: p.role || 'Employee',
                    employeeId: p.employeeId || 'EMP0000',
                    lastLogin: p.lastLoginAt || new Date().toISOString(),
                    twoFAEnabled: !!p.twoFAEnabled
                };
                displayProfile();
                refreshSecurityUI();
            }catch{
                // fallback to existing local demo profile
                const storedProfile = localStorage.getItem(profileKey(username));
                if (storedProfile) { currentProfile = JSON.parse(storedProfile); } else { currentProfile = { name: username, username, email: `${username}@company.com`, phone: '+1 (555) 123-4567', department: 'Operations', role: 'Employee', employeeId: `EMP${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`, lastLogin: new Date().toISOString(), twoFAEnabled: false }; localStorage.setItem(profileKey(username), JSON.stringify(currentProfile)); }
                displayProfile();
            }
        }

        // Display profile information
        function displayProfile() {
            document.getElementById('profileName').textContent = currentProfile.name;
            document.getElementById('profileUsername').textContent = currentProfile.username;
            document.getElementById('profileEmail').textContent = currentProfile.email;
            document.getElementById('profilePhone').textContent = currentProfile.phone;
            document.getElementById('profileDepartment').textContent = currentProfile.department;
            document.getElementById('profileRole').textContent = currentProfile.role;
            document.getElementById('profileEmployeeId').textContent = currentProfile.employeeId;
            document.getElementById('profileLastLogin').textContent = new Date(currentProfile.lastLogin).toLocaleString();
        }

        // Edit profile modal
        function editProfile() {
            document.getElementById('editName').value = currentProfile.name;
            document.getElementById('editEmail').value = currentProfile.email;
            document.getElementById('editPhone').value = currentProfile.phone;
            document.getElementById('editDepartment').value = currentProfile.department;
            document.getElementById('editProfileModal').style.display = 'block';
        }
        function closeEditModal() { document.getElementById('editProfileModal').style.display = 'none'; }

        // Save profile changes
        async function saveProfile(event) {
            event.preventDefault();
            const fullName = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const department = document.getElementById('editDepartment').value;
            try{
                const resp = await fetch(`${API_BASE}/api/profile`, { method:'PUT', headers: authHeaders(), body: JSON.stringify({ fullName, email, phone, department }) });
                if(!resp.ok) throw new Error('Failed');
                currentProfile.name = fullName; currentProfile.email = email; currentProfile.phone = phone; currentProfile.department = department;
                displayProfile(); closeEditModal(); alert('Profile updated successfully!');
            }catch{
                alert('Failed to update profile.');
            }
        }

        // Change password (demo validation retained)
        function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (currentPassword !== 'password') { alert('Current password is incorrect.'); return; }
            if (newPassword !== confirmPassword) { alert('New passwords do not match.'); return; }
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
            if (!passwordRegex.test(newPassword)) { alert('Password does not meet requirements.'); return; }
            alert('Password changed successfully! (This is a demo - no actual password change occurs)');
            document.getElementById('changePasswordForm').reset();
            const username = getUsername();
            if (window.addAuditLog) { window.addAuditLog(username, 'Change Password', 'Password changed successfully', 'medium'); }
        }

        // Login history
        function loadLoginHistory() {
            const username = getUsername();
            const loginHistory = JSON.parse(localStorage.getItem(`loginHistory_${username}`) || '[]');
            if (loginHistory.length === 0) {
                const sampleHistory = [
                    { timestamp: new Date().toISOString(), ipAddress: '192.168.1.100', device: navigator.userAgent, status: 'Success', location: 'Office Network' },
                    { timestamp: new Date(Date.now() - 86400000).toISOString(), ipAddress: '192.168.1.100', device: navigator.userAgent, status: 'Success', location: 'Office Network' }
                ];
                localStorage.setItem(`loginHistory_${username}`, JSON.stringify(sampleHistory));
                displayLoginHistory(sampleHistory);
            } else {
                displayLoginHistory(loginHistory);
            }
        }
        function displayLoginHistory(history) {
            const tableBody = document.getElementById('loginHistoryTable');
            if (history.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">
                            <i class="fas fa-inbox"></i>
                            <p>No login history found.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            tableBody.innerHTML = history.map(entry => `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>${entry.ipAddress}</td>
                    <td>${entry.device.substring(0, 50)}...</td>
                    <td><span class="status-badge success">${entry.status}</span></td>
                    <td>${entry.location}</td>
                </tr>
            `).join('');
        }
        function refreshLoginHistory() { loadLoginHistory(); }

        // Tax profile + forecast
        async function loadTax() {
            try{
                const token = localStorage.getItem('authToken');
                const headers = { 'Authorization': `Bearer ${token}` };
                const forecastResp = await fetch(`${API_BASE}/api/tax/forecast`, { headers });
                if (forecastResp.ok) {
                    const f = await forecastResp.json();
                    document.getElementById('taxRegime').textContent = f.regime.toUpperCase();
                    document.getElementById('taxGross').textContent = `$${(f.gross/100).toFixed(2)}`;
                    document.getElementById('taxDeductions').textContent = `$${(f.deductions/100).toFixed(2)}`;
                    document.getElementById('taxTaxable').textContent = `$${(f.taxable/100).toFixed(2)}`;
                    document.getElementById('taxMonthlyTDS').textContent = `$${(f.projectedMonthlyTDS/100).toFixed(2)}`;
                }
                const profileResp = await fetch(`${API_BASE}/api/tax/profile`, { headers });
                if (profileResp.ok) {
                    const d = await profileResp.json();
                    const p = d.profile || {};
                    document.getElementById('panInput').value = p.pan || '';
                    document.getElementById('regimeInput').value = (p.regime || 'old');
                    document.getElementById('s80cInput').value = p.section80C ? (p.section80C/100).toFixed(2) : '';
                    document.getElementById('hraInput').value = p.hraExempt ? (p.hraExempt/100).toFixed(2) : '';
                    document.getElementById('ltaInput').value = p.ltaExempt ? (p.ltaExempt/100).toFixed(2) : '';
                }
            }catch{}
        }
        async function saveTaxProfile(e){
            e.preventDefault();
            const payload = {
                pan: document.getElementById('panInput').value || undefined,
                regime: document.getElementById('regimeInput').value,
                section80C: Math.round(parseFloat(document.getElementById('s80cInput').value||'0')*100),
                hraExempt: Math.round(parseFloat(document.getElementById('hraInput').value||'0')*100),
                ltaExempt: Math.round(parseFloat(document.getElementById('ltaInput').value||'0')*100)
            };
            try{
                const resp = await fetch(`${API_BASE}/api/tax/profile`, { method:'PUT', headers: authHeaders(), body: JSON.stringify(payload) });
                if(!resp.ok) throw new Error();
                alert('Saved tax profile');
                loadTax();
            }catch{ alert('Failed to save tax profile'); }
        }
        function downloadForm16(){
            const year = new Date().getFullYear();
            fetch(`${API_BASE}/api/tax/form16/${year}/pdf`, { headers: authHeaders() })
                .then(r => r.blob())
                .then(b => { const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href=url; a.download=`Form16_${year}.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); })
                .catch(()=> alert('Failed to download Form 16'));
        }

        // 2FA UI and logic
        function refreshSecurityUI() {
            const sec = { twoFAEnabled: !!currentProfile.twoFAEnabled };
            const btn = document.getElementById('twoFAButton');
            if (!btn) return;
            if (sec.twoFAEnabled) {
                btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Manage 2FA';
            } else {
                btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Enable 2FA';
            }
        }
        async function enable2FA() {
            // Prepare modal content
            const modal = document.getElementById('twoFAModal');
            const body = document.getElementById('twoFAModalBody');
            if (!currentProfile.twoFAEnabled) {
                // New setup flow via backend
                let setup;
                try{
                    const resp = await fetch(`${API_BASE}/api/2fa/setup`, { method:'POST', headers: authHeaders() });
                    if(!resp.ok) throw new Error('Failed');
                    setup = await resp.json();
                }catch{ alert('Failed to start 2FA setup.'); return; }
                const secret = setup.base32;
                const uri = setup.otpauthUrl;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(uri)}`;
                body.innerHTML = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Scan QR with your authenticator app</label>
                            <div class="qr-box">
                                <img src="${qrUrl}" alt="QR Code" width="180" height="180"/>
                                <div class="small muted">
                                    If you cannot scan, enter this secret manually:<br>
                                    <code>${secret}</code>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Enter 6-digit code to verify</label>
                            <input type="text" id="twoFAVerifyCode" placeholder="123456" pattern="\\d{6}" maxlength="6" required>
                            <div class="small muted">Codes rotate every 30 seconds.</div>
                        </div>
                    </div>
                    <div class="modal-actions" style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top: 0.75rem;">
                        <button class="secondary-btn" onclick="closeTwoFAModal()">Cancel</button>
                        <button class="primary-btn" onclick="confirmEnable2FA('${secret}')">Verify & Enable</button>
                    </div>
                `;
            } else {
                // Management: show actions
                body.innerHTML = `
                    <div class="form-group">
                        <label>Two-Factor Authentication is enabled</label>
                        <div class="small muted">You can regenerate recovery codes if needed.</div>
                    </div>
                    <div class="modal-actions" style="display:flex; gap:0.5rem; justify-content:space-between; margin-top: 0.75rem;">
                        <div>
                            <button class="secondary-btn" onclick="regenerateRecoveryCodes()"><i class="fas fa-sync-alt"></i> Regenerate Codes</button>
                        </div>
                        <div>
                            <button class="secondary-btn" onclick="closeTwoFAModal()">Close</button>
                            <button class="danger" onclick="disable2FA()"><i class="fas fa-ban"></i> Disable 2FA</button>
                        </div>
                    </div>
                `;
            }
            modal.style.display = 'block';
        }
        async function confirmEnable2FA(secret) {
            const input = document.getElementById('twoFAVerifyCode');
            if (!input) return;
            const code = (input.value || '').trim();
            if (!/^\d{6}$/.test(code)) { alert('Enter a valid 6-digit code.'); return; }
            try {
                const resp = await fetch(`${API_BASE}/api/2fa/enable`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ base32: secret, code }) });
                if(!resp.ok){ alert('Invalid code. Try again.'); return; }
                const data = await resp.json();
                currentProfile.twoFAEnabled = true;
                alert('Two-Factor Authentication enabled. Save your recovery codes!');
                const body = document.getElementById('twoFAModalBody');
                body.innerHTML = `<div class="form-group"><label>Recovery Codes</label><div class="code-grid">${(data.recoveryCodes||[]).map((c)=>`<div class=\"code-item\">${c}</div>`).join('')}</div></div><div class="modal-actions" style="justify-content:flex-end; display:flex; gap:0.5rem; margin-top:0.75rem;"><button class="primary-btn" onclick="closeTwoFAModal()">Done</button></div>`;
                refreshSecurityUI();
            } catch (e) {
                alert('Failed to enable 2FA.');
            }
        }
        function regenerateRecoveryCodes() {
            fetch(`${API_BASE}/api/2fa/recovery/regenerate`, { method:'POST', headers: authHeaders() })
                .then(r=> r.json())
                .then(d=>{
                    const body = document.getElementById('twoFAModalBody');
                    body.innerHTML = `<div class="form-group"><label>New Recovery Codes</label><div class="code-grid">${(d.recoveryCodes||[]).map((c)=>`<div class=\"code-item\">${c}</div>`).join('')}</div></div><div class="modal-actions" style="justify-content:flex-end; display:flex; gap:0.5rem; margin-top:0.75rem;"><button class="primary-btn" onclick="closeTwoFAModal()">Done</button></div>`;
                    alert('New recovery codes generated. Store them securely.');
                })
                .catch(()=> alert('Failed to regenerate recovery codes.'));
        }
        function disable2FA() {
            if (!confirm('Disable 2FA? You will no longer be prompted for verification codes.')) return;
            fetch(`${API_BASE}/api/2fa/disable`, { method:'POST', headers: authHeaders() })
                .then(()=>{ currentProfile.twoFAEnabled = false; closeTwoFAModal(); refreshSecurityUI(); })
                .catch(()=> alert('Failed to disable 2FA'));
        }
        function closeTwoFAModal() { document.getElementById('twoFAModal').style.display = 'none'; }

        // Sessions UI
        async function viewSessions() {
            const currentId = localStorage.getItem('currentSessionId');
            let sessions = [];
            try{
                const resp = await fetch(`${API_BASE}/api/sessions`, { headers: authHeaders() });
                if(resp.ok){ const d = await resp.json(); sessions = d.sessions || []; }
            }catch{}
            const tbody = document.getElementById('sessionsTableBody');
            if (sessions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="no-data"><i class=\"fas fa-inbox\"></i> No active sessions.</td></tr>`;
            } else {
                tbody.innerHTML = sessions.map(s => `
                    <tr>
                        <td>${new Date(s.createdAt).toLocaleString()}</td>
                        <td>${new Date(s.lastActive).toLocaleString()}</td>
                        <td>${(s.userAgent || '').substring(0, 40)}...</td>
                        <td>${s.ipAddress || 'Unknown'}</td>
                        <td style="display:flex; gap:0.5rem;">
                            ${s.id === currentId ? '<span class="status-badge success">Current</span>' : ''}
                            <button class="secondary-btn small" onclick="revokeSession(\'${s.id}\')"><i class=\"fas fa-sign-out-alt\"></i> Revoke</button>
                        </td>
                    </tr>
                `).join('');
            }
            document.getElementById('sessionsModal').style.display = 'block';
        }
        function closeSessionsModal() { document.getElementById('sessionsModal').style.display = 'none'; }
        async function revokeSession(sessionId) {
            const currentSessionId = localStorage.getItem('currentSessionId');
            if (sessionId === currentSessionId) { alert('Revoking current session will log you out.'); logout(); return; }
            try{ await fetch(`${API_BASE}/api/sessions/${sessionId}`, { method:'DELETE', headers: authHeaders() }); viewSessions(); } catch {}
        }

        // Logout function
        function logout() {
            const username = getUsername();
            // Remove current session
            const currentSessionId = localStorage.getItem('currentSessionId');
            if (username && currentSessionId) {
                const sessions = getSessions(username).filter(s => s.id !== currentSessionId);
                setSessions(username, sessions);
                localStorage.removeItem('currentSessionId');
            }
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = [
                document.getElementById('editProfileModal'),
                document.getElementById('twoFAModal'),
                document.getElementById('sessionsModal')
            ];
            modals.forEach(modal => {
                if (event.target === modal) { modal.style.display = 'none'; }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Payroll Management</h1>
            <div class="user-info">
                <span id="currentUser">Loading...</span>
                <button onclick="logout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-user-tie"></i>
                <span>Employee Portal</span>
            </div>
            <ul class="nav-links">
                <li>
                    <a href="employee-dashboard.html">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="employee-reports.html">
                        <i class="fas fa-file-alt"></i>
                        <span>My Reports</span>
                    </a>
                </li>
                <li class="active">
                    <a href="employee-profile.html">
                        <i class="fas fa-user-cog"></i>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2><i class="fas fa-user-cog"></i> My Profile</h2>
                <p>Manage your personal information and account settings.</p>
            </div>

            <!-- Profile Information -->
            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-user"></i> Personal Information</h3>
                    <button onclick="editProfile()" class="primary-btn" id="editProfileBtn">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                </div>
                <div class="profile-grid">
                    <div class="profile-field">
                        <label>Full Name:</label>
                        <span id="profileName">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Username:</label>
                        <span id="profileUsername">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Email:</label>
                        <span id="profileEmail">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Phone:</label>
                        <span id="profilePhone">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Department:</label>
                        <span id="profileDepartment">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Role:</label>
                        <span id="profileRole">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Employee ID:</label>
                        <span id="profileEmployeeId">Loading...</span>
                    </div>
                    <div class="profile-field">
                        <label>Last Login:</label>
                        <span id="profileLastLogin">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Edit Profile Modal -->
            <div id="editProfileModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-user-edit"></i> Edit Profile</h3>
                        <span class="close" onclick="closeEditModal()">&times;</span>
                    </div>
                    <form id="editProfileForm" onsubmit="saveProfile(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editName">Full Name:</label>
                                <input type="text" id="editName" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail">Email:</label>
                                <input type="email" id="editEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="editPhone">Phone:</label>
                                <input type="tel" id="editPhone">
                            </div>
                            <div class="form-group">
                                <label for="editDepartment">Department:</label>
                                <input type="text" id="editDepartment">
                            </div>
                        </div>
                        <div class="modal-actions" style="display:flex; gap:0.5rem; justify-content:flex-end; margin-top: 0.75rem;">
                            <button type="button" onclick="closeEditModal()" class="secondary-btn">Cancel</button>
                            <button type="submit" class="primary-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Change Password -->
            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-lock"></i> Change Password</h3>
                </div>
                <form id="changePasswordForm" onsubmit="changePassword(event)" class="password-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="currentPassword">Current Password:</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password:</label>
                            <input type="password" id="newPassword" required minlength="8">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" required minlength="8">
                        </div>
                    </div>
                    <div class="password-requirements">
                        <p><strong>Password Requirements:</strong></p>
                        <ul>
                            <li>Minimum 8 characters</li>
                            <li>At least one uppercase letter</li>
                            <li>At least one lowercase letter</li>
                            <li>At least one number</li>
                        </ul>
                    </div>
                    <button type="submit" class="primary-btn">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </form>
            </div>

            <!-- Login History -->
            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-history"></i> Login History</h3>
                    <button onclick="refreshLoginHistory()" class="secondary-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>IP Address</th>
                                <th>Device</th>
                                <th>Status</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="loginHistoryTable">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tax & TDS -->
            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-receipt"></i> Tax & TDS</h3>
                    <button onclick="downloadForm16()" class="secondary-btn"><i class="fas fa-file-pdf"></i> Download Form 16</button>
                </div>
                <div class="profile-grid">
                    <div class="profile-field"><label>Regime:</label><span id="taxRegime">Loading...</span></div>
                    <div class="profile-field"><label>Gross (YTD):</label><span id="taxGross">Loading...</span></div>
                    <div class="profile-field"><label>Deductions (YTD):</label><span id="taxDeductions">Loading...</span></div>
                    <div class="profile-field"><label>Taxable (YTD):</label><span id="taxTaxable">Loading...</span></div>
                    <div class="profile-field"><label>Projected Monthly TDS:</label><span id="taxMonthlyTDS">Loading...</span></div>
                </div>
                <div style="margin-top:10px;">
                    <form onsubmit="saveTaxProfile(event)">
                        <div class="form-grid">
                            <div class="form-group"><label>PAN</label><input id="panInput" placeholder="ABCDE1234F"></div>
                            <div class="form-group"><label>Regime</label><select id="regimeInput"><option value="old">Old</option><option value="new">New</option></select></div>
                            <div class="form-group"><label>Section 80C ($)</label><input id="s80cInput" type="number" step="0.01" min="0"></div>
                            <div class="form-group"><label>HRA Exempt ($)</label><input id="hraInput" type="number" step="0.01" min="0"></div>
                            <div class="form-group"><label>LTA Exempt ($)</label><input id="ltaInput" type="number" step="0.01" min="0"></div>
                        </div>
                        <div class="modal-actions" style="justify-content:flex-end;">
                            <button class="primary-btn" type="submit"><i class="fas fa-save"></i> Save Tax Profile</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Account Security -->
            <div class="content-section">
                <div class="section-header">
                    <h3><i class="fas fa-shield-alt"></i> Account Security</h3>
                </div>
                <div class="security-options">
                    <div class="security-option">
                        <div class="security-info">
                            <h4>Two-Factor Authentication</h4>
                            <p>Add an extra layer of security to your account</p>
                        </div>
                        <button id="twoFAButton" class="secondary-btn" onclick="enable2FA()">
                            <i class="fas fa-mobile-alt"></i> Enable 2FA
                        </button>
                    </div>
                    <div class="security-option">
                        <div class="security-info">
                            <h4>Session Management</h4>
                            <p>View and manage active sessions</p>
                        </div>
                        <button class="secondary-btn" onclick="viewSessions()">
                            <i class="fas fa-desktop"></i> View Sessions
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Footer -->
    <footer>
        <p>&copy; 2025 PayrollPro by Aaron | Employee Portal</p>
    </footer>

    <!-- 2FA Modal -->
    <div id="twoFAModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-mobile-alt"></i> Two-Factor Authentication</h3>
                <span class="close" onclick="closeTwoFAModal()">&times;</span>
            </div>
            <div id="twoFAModalBody"></div>
        </div>
    </div>

    <!-- Sessions Modal -->
    <div id="sessionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-desktop"></i> Active Sessions</h3>
                <span class="close" onclick="closeSessionsModal()">&times;</span>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Signed In</th>
                            <th>Last Active</th>
                            <th>Device</th>
                            <th>IP</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
