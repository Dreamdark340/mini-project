<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Tracking - Payroll Management</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    function logout(){ localStorage.removeItem('authToken'); localStorage.removeItem('userRole'); localStorage.removeItem('username'); localStorage.removeItem('fullName'); window.location.href='login.html'; }
    function checkAuth(){ const t=localStorage.getItem('authToken'); const r=localStorage.getItem('userRole'); const u=localStorage.getItem('username'); if(!t||!r||!u){ window.location.href='login.html'; return; } document.getElementById('currentUser').innerHTML=`<span>${localStorage.getItem('fullName') || u}</span><span class="role-badge">${r.toUpperCase()}</span>`; document.body.classList.add('employee-theme'); loadTimeTrackingData(); }
    
    let currentTimer = null;
    let startTime = null;
    let isRunning = false;
    
    function loadTimeTrackingData() {
        const username = localStorage.getItem('username');
        loadTodayHours(username);
        loadWeeklyHours(username);
        loadTimeEntries(username);
    }
    
    function startTimer() {
        if (isRunning) return;
        
        startTime = new Date();
        isRunning = true;
        
        currentTimer = setInterval(updateTimer, 1000);
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('timerStatus').textContent = 'Timer Running';
        document.getElementById('timerStatus').className = 'status-badge success';
        
        // Add activity
        addActivity('Started time tracking', 'Success');
    }
    
    function stopTimer() {
        if (!isRunning || !startTime) return;
        
        clearInterval(currentTimer);
        const endTime = new Date();
        const duration = Math.floor((endTime - startTime) / 1000);
        const hours = Math.floor(duration / 3600);
        const minutes = Math.floor((duration % 3600) / 60);
        
        // Save time entry
        saveTimeEntry(startTime, endTime, hours, minutes);
        
        isRunning = false;
        startTime = null;
        
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('timerStatus').textContent = 'Timer Stopped';
        document.getElementById('timerStatus').className = 'status-badge warning';
        document.getElementById('currentTime').textContent = '00:00:00';
        
        // Add activity
        addActivity(`Stopped time tracking (${hours}h ${minutes}m)`, 'Success');
        
        // Reload data
        loadTimeTrackingData();
    }
    
    function updateTimer() {
        if (!startTime) return;
        
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('currentTime').textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function saveTimeEntry(start, end, hours, minutes) {
        const username = localStorage.getItem('username');
        const entry = {
            id: Date.now(),
            date: start.toISOString().split('T')[0],
            startTime: start.toTimeString().split(' ')[0].substring(0, 5),
            endTime: end.toTimeString().split(' ')[0].substring(0, 5),
            duration: `${hours}h ${minutes}m`,
            totalMinutes: hours * 60 + minutes
        };
        
        const entries = JSON.parse(localStorage.getItem(`timeEntries_${username}`) || '[]');
        entries.unshift(entry);
        localStorage.setItem(`timeEntries_${username}`, JSON.stringify(entries.slice(0, 100))); // Keep last 100 entries
    }
    
    function loadTodayHours(username) {
        const today = new Date().toISOString().split('T')[0];
        const entries = JSON.parse(localStorage.getItem(`timeEntries_${username}`) || '[]');
        const todayEntries = entries.filter(entry => entry.date === today);
        
        const totalMinutes = todayEntries.reduce((sum, entry) => sum + entry.totalMinutes, 0);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        document.getElementById('todayHours').textContent = `${hours}h ${minutes}m`;
        
        if (todayEntries.length === 0) {
            document.getElementById('todayHours').textContent = '0h 0m';
        }
    }
    
    function loadWeeklyHours(username) {
        const entries = JSON.parse(localStorage.getItem(`timeEntries_${username}`) || '[]');
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        
        const weekEntries = entries.filter(entry => new Date(entry.date) >= weekAgo);
        const totalMinutes = weekEntries.reduce((sum, entry) => sum + entry.totalMinutes, 0);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        document.getElementById('weeklyHours').textContent = `${hours}h ${minutes}m`;
    }
    
    function loadTimeEntries(username) {
        const entries = JSON.parse(localStorage.getItem(`timeEntries_${username}`) || '[]');
        const tbody = document.getElementById('timeEntriesBody');
        
        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="no-data">No time entries found</td></tr>';
            return;
        }
        
        tbody.innerHTML = entries.slice(0, 20).map(entry => `
            <tr>
                <td>${new Date(entry.date).toLocaleDateString()}</td>
                <td>${entry.startTime}</td>
                <td>${entry.endTime}</td>
                <td>${entry.duration}</td>
                <td>
                    <button class="secondary-btn small" onclick="deleteTimeEntry(${entry.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function deleteTimeEntry(id) {
        if (!confirm('Delete this time entry?')) return;
        
        const username = localStorage.getItem('username');
        const entries = JSON.parse(localStorage.getItem(`timeEntries_${username}`) || '[]');
        const filtered = entries.filter(entry => entry.id !== id);
        localStorage.setItem(`timeEntries_${username}`, JSON.stringify(filtered));
        
        loadTimeTrackingData();
        addActivity('Deleted time entry', 'Success');
    }
    
    function addActivity(action, status) {
        const username = localStorage.getItem('username');
        const activity = {
            date: new Date().toLocaleDateString(),
            action: action,
            status: status
        };
        
        const activities = JSON.parse(localStorage.getItem(`activities_${username}`) || '[]');
        activities.unshift(activity);
        localStorage.setItem(`activities_${username}`, JSON.stringify(activities.slice(0, 50)));
    }
    
    // Check if timer was running when page was closed
    function checkRunningTimer() {
        const username = localStorage.getItem('username');
        const runningTimer = localStorage.getItem(`runningTimer_${username}`);
        
        if (runningTimer) {
            const timerData = JSON.parse(runningTimer);
            startTime = new Date(timerData.startTime);
            
            // Check if timer has been running for more than 24 hours (auto-stop)
            const now = new Date();
            const hoursRunning = (now - startTime) / (1000 * 60 * 60);
            
            if (hoursRunning > 24) {
                localStorage.removeItem(`runningTimer_${username}`);
                return;
            }
            
            isRunning = true;
            currentTimer = setInterval(updateTimer, 1000);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('timerStatus').textContent = 'Timer Running';
            document.getElementById('timerStatus').className = 'status-badge success';
        }
    }
    
    // Save running timer state
    function saveRunningTimer() {
        if (isRunning && startTime) {
            const username = localStorage.getItem('username');
            localStorage.setItem(`runningTimer_${username}`, JSON.stringify({
                startTime: startTime.toISOString()
            }));
        }
    }
    
    // Clean up on page unload
    window.addEventListener('beforeunload', saveRunningTimer);
    
    document.addEventListener('DOMContentLoaded', () => {
        checkAuth();
        checkRunningTimer();
    });
  </script>
  <style>
    .timer-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 30px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .timer-display {
      font-size: 3rem;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      color: var(--primary);
    }
    .timer-controls {
      display: flex;
      gap: 10px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .stat-card h4 {
      margin: 0 0 8px;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .stat-card .value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1><i class="fas fa-clock"></i> Time Tracking</h1>
      <div class="user-info">
        <span id="currentUser">Loading...</span>
        <button onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
  </header>
  
  <div class="container">
    <nav class="sidebar">
      <div class="sidebar-header"><i class="fas fa-user-tie"></i><span>Employee Portal</span></div>
      <ul class="nav-links">
        <li><a href="employee-dashboard.html"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
        <li><a href="employee-reports.html"><i class="fas fa-file-alt"></i><span>My Reports</span></a></li>
        <li><a href="employee-profile.html"><i class="fas fa-user-cog"></i><span>Profile</span></a></li>
        <li class="active"><a href="time-tracking.html"><i class="fas fa-clock"></i><span>Time Tracking</span></a></li>
      </ul>
    </nav>
    
    <main class="main-content">
      <div class="page-header">
        <h2><i class="fas fa-clock"></i> Time Tracking</h2>
        <p>Track your work hours and manage time entries.</p>
      </div>
      
      <!-- Timer Section -->
      <div class="timer-container">
        <div>
          <div class="timer-display" id="currentTime">00:00:00</div>
          <div style="text-align: center; margin-top: 10px;">
            <span id="timerStatus" class="status-badge warning">Timer Stopped</span>
          </div>
        </div>
        <div class="timer-controls">
          <button id="startBtn" class="primary-btn" onclick="startTimer()">
            <i class="fas fa-play"></i> Start
          </button>
          <button id="stopBtn" class="danger" onclick="stopTimer()" disabled>
            <i class="fas fa-stop"></i> Stop
          </button>
        </div>
      </div>
      
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h4>Today's Hours</h4>
          <div class="value" id="todayHours">0h 0m</div>
        </div>
        <div class="stat-card">
          <h4>This Week</h4>
          <div class="value" id="weeklyHours">0h 0m</div>
        </div>
        <div class="stat-card">
          <h4>Average/Day</h4>
          <div class="value" id="avgHours">8h 0m</div>
        </div>
      </div>
      
      <!-- Time Entries -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-list"></i> Recent Time Entries</h3>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="timeEntriesBody">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
  
  <footer><p>&copy; 2025 PayrollPro by Aaron | Time Tracking</p></footer>
</body>
</html>