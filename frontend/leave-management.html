<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave Management - PayrollPro</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="navigation-enhancer.js"></script>
  <script src="init-demo-data.js"></script>
  <script>
    function logout(){ localStorage.removeItem('authToken'); localStorage.removeItem('userRole'); localStorage.removeItem('username'); localStorage.removeItem('fullName'); window.location.href='../login.html'; }
    function checkAuth(){ const t=localStorage.getItem('authToken'); const r=localStorage.getItem('userRole'); const u=localStorage.getItem('username'); if(!t||!r||!u){ window.location.href='../login.html'; return; } document.getElementById('currentUser').innerHTML=`<span>${localStorage.getItem('fullName') || u}</span><span class="role-badge">${r.toUpperCase()}</span>`; document.body.classList.add('employee-theme'); loadLeaveData(); loadAttendanceData(); }

    // Leave Management System
    const LEAVE_TYPES = {
      'sick': { name: 'Sick Leave', maxDays: 12, color: '#ef4444' },
      'vacation': { name: 'Vacation Leave', maxDays: 21, color: '#3b82f6' },
      'personal': { name: 'Personal Leave', maxDays: 5, color: '#8b5cf6' },
      'emergency': { name: 'Emergency Leave', maxDays: 3, color: '#f59e0b' },
      'maternity': { name: 'Maternity Leave', maxDays: 90, color: '#ec4899' },
      'paternity': { name: 'Paternity Leave', maxDays: 15, color: '#06b6d4' }
    };

    let leaveData = JSON.parse(localStorage.getItem('leaveData') || '[]');
    let attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '[]');

    function loadLeaveData() {
      const username = localStorage.getItem('username');
      const userRole = localStorage.getItem('userRole');
      
      // Load leave balance
      loadLeaveBalance(username);
      
      // Load leave requests
      loadLeaveRequests(username, userRole);
    }

    function loadLeaveBalance(username) {
      const balance = JSON.parse(localStorage.getItem(`leaveBalance_${username}`) || JSON.stringify({
        sick: 12,
        vacation: 21,
        personal: 5,
        emergency: 3,
        maternity: 90,
        paternity: 15
      }));

      const balanceContainer = document.getElementById('leaveBalance');
      balanceContainer.innerHTML = Object.entries(balance).map(([type, days]) => {
        const leaveType = LEAVE_TYPES[type];
        const percentage = (days / leaveType.maxDays) * 100;
        return `
          <div class="leave-balance-item">
            <div class="leave-type-header">
              <span class="leave-type-name" style="color: ${leaveType.color}">${leaveType.name}</span>
              <span class="leave-days">${days}/${leaveType.maxDays} days</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percentage}%; background: ${leaveType.color}"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function loadLeaveRequests(username, userRole) {
      const requests = leaveData.filter(req => 
        userRole === 'hr' || userRole === 'admin' || req.username === username
      );

      const requestsContainer = document.getElementById('leaveRequests');
      if (requests.length === 0) {
        requestsContainer.innerHTML = '<div class="no-data">No leave requests found</div>';
        return;
      }

      requestsContainer.innerHTML = requests.map(request => {
        const leaveType = LEAVE_TYPES[request.type];
        const statusClass = request.status === 'approved' ? 'success' : 
                           request.status === 'rejected' ? 'danger' : 'warning';
        const canApprove = (userRole === 'hr' || userRole === 'admin') && request.status === 'pending';
        
        return `
          <div class="leave-request-card">
            <div class="request-header">
              <div class="request-info">
                <h4>${request.fullName || request.username}</h4>
                <span class="leave-type-badge" style="background: ${leaveType.color}">${leaveType.name}</span>
              </div>
              <div class="request-status">
                <span class="status-badge ${statusClass}">${request.status.toUpperCase()}</span>
                ${canApprove ? `
                  <div class="approval-buttons">
                    <button onclick="approveLeave('${request.id}')" class="secondary-btn small success">
                      <i class="fas fa-check"></i> Approve
                    </button>
                    <button onclick="rejectLeave('${request.id}')" class="secondary-btn small danger">
                      <i class="fas fa-times"></i> Reject
                    </button>
                  </div>
                ` : ''}
              </div>
            </div>
            <div class="request-details">
              <div class="detail-item">
                <i class="fas fa-calendar-alt"></i>
                <span>${new Date(request.startDate).toLocaleDateString()} - ${new Date(request.endDate).toLocaleDateString()}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>${request.days} day(s)</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-comment"></i>
                <span>${request.reason || 'No reason provided'}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-calendar-plus"></i>
                <span>Requested: ${new Date(request.requestedAt).toLocaleDateString()}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function loadAttendanceData() {
      const username = localStorage.getItem('username');
      const userRole = localStorage.getItem('userRole');
      
      // Load attendance summary
      loadAttendanceSummary(username);
      
      // Load attendance history
      loadAttendanceHistory(username, userRole);
    }

    function loadAttendanceSummary(username) {
      const userAttendance = attendanceData.filter(att => att.username === username);
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      
      const monthAttendance = userAttendance.filter(att => {
        const attDate = new Date(att.date);
        return attDate.getMonth() === currentMonth && attDate.getFullYear() === currentYear;
      });

      const presentDays = monthAttendance.filter(att => att.status === 'present').length;
      const absentDays = monthAttendance.filter(att => att.status === 'absent').length;
      const lateDays = monthAttendance.filter(att => att.status === 'late').length;
      const totalWorkingDays = new Date().getDate(); // Simplified calculation

      document.getElementById('attendanceSummary').innerHTML = `
        <div class="attendance-stats">
          <div class="stat-item">
            <div class="stat-number" style="color: #16a34a">${presentDays}</div>
            <div class="stat-label">Present</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" style="color: #ef4444">${absentDays}</div>
            <div class="stat-label">Absent</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" style="color: #f59e0b">${lateDays}</div>
            <div class="stat-label">Late</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" style="color: #3b82f6">${((presentDays / totalWorkingDays) * 100).toFixed(1)}%</div>
            <div class="stat-label">Attendance</div>
          </div>
        </div>
      `;
    }

    function loadAttendanceHistory(username, userRole) {
      const userAttendance = attendanceData.filter(att => 
        userRole === 'hr' || userRole === 'admin' || att.username === username
      );

      const historyContainer = document.getElementById('attendanceHistory');
      if (userAttendance.length === 0) {
        historyContainer.innerHTML = '<div class="no-data">No attendance records found</div>';
        return;
      }

      // Group by month
      const groupedAttendance = userAttendance.reduce((acc, att) => {
        const month = new Date(att.date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        if (!acc[month]) acc[month] = [];
        acc[month].push(att);
        return acc;
      }, {});

      historyContainer.innerHTML = Object.entries(groupedAttendance).map(([month, records]) => `
        <div class="attendance-month">
          <h4>${month}</h4>
          <div class="attendance-grid">
            ${records.map(record => {
              const statusClass = record.status === 'present' ? 'success' : 
                                 record.status === 'absent' ? 'danger' : 'warning';
              return `
                <div class="attendance-day ${statusClass}">
                  <div class="day-date">${new Date(record.date).getDate()}</div>
                  <div class="day-status">${record.status}</div>
                  ${record.checkIn ? `<div class="day-time">${record.checkIn}</div>` : ''}
                  ${record.checkOut ? `<div class="day-time">${record.checkOut}</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
    }

    function openLeaveRequestModal() {
      document.getElementById('leaveRequestModal').style.display = 'block';
    }

    function closeLeaveRequestModal() {
      document.getElementById('leaveRequestModal').style.display = 'none';
      document.getElementById('leaveRequestForm').reset();
    }

    function submitLeaveRequest(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const request = {
        id: 'req_' + Date.now(),
        username: localStorage.getItem('username'),
        fullName: localStorage.getItem('fullName') || localStorage.getItem('username'),
        type: formData.get('leaveType'),
        startDate: formData.get('startDate'),
        endDate: formData.get('endDate'),
        days: calculateDays(formData.get('startDate'), formData.get('endDate')),
        reason: formData.get('reason'),
        status: 'pending',
        requestedAt: new Date().toISOString()
      };

      // Check leave balance
      const username = localStorage.getItem('username');
      const balance = JSON.parse(localStorage.getItem(`leaveBalance_${username}`) || '{}');
      const leaveType = LEAVE_TYPES[request.type];
      
      if (balance[request.type] < request.days) {
        alert(`Insufficient ${leaveType.name} balance. Available: ${balance[request.type]} days`);
        return;
      }

      leaveData.push(request);
      localStorage.setItem('leaveData', JSON.stringify(leaveData));
      
      closeLeaveRequestModal();
      loadLeaveData();
      
      alert('Leave request submitted successfully!');
    }

    function calculateDays(startDate, endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffTime = Math.abs(end - start);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    }

    function approveLeave(requestId) {
      const request = leaveData.find(req => req.id === requestId);
      if (request) {
        request.status = 'approved';
        request.approvedAt = new Date().toISOString();
        request.approvedBy = localStorage.getItem('username');
        
        // Deduct from leave balance
        const balance = JSON.parse(localStorage.getItem(`leaveBalance_${request.username}`) || '{}');
        balance[request.type] = Math.max(0, balance[request.type] - request.days);
        localStorage.setItem(`leaveBalance_${request.username}`, JSON.stringify(balance));
        
        localStorage.setItem('leaveData', JSON.stringify(leaveData));
        loadLeaveData();
        alert('Leave request approved!');
      }
    }

    function rejectLeave(requestId) {
      const request = leaveData.find(req => req.id === requestId);
      if (request) {
        request.status = 'rejected';
        request.rejectedAt = new Date().toISOString();
        request.rejectedBy = localStorage.getItem('username');
        
        localStorage.setItem('leaveData', JSON.stringify(leaveData));
        loadLeaveData();
        alert('Leave request rejected!');
      }
    }

    function markAttendance() {
      const username = localStorage.getItem('username');
      const today = new Date().toISOString().split('T')[0];
      const now = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
      
      // Check if already marked today
      const existingRecord = attendanceData.find(att => 
        att.username === username && att.date === today
      );
      
      if (existingRecord) {
        if (existingRecord.checkOut) {
          alert('You have already marked attendance for today!');
          return;
        }
        // Mark check out
        existingRecord.checkOut = now;
        existingRecord.status = 'present';
      } else {
        // Mark check in
        const isLate = new Date().getHours() > 9; // Late after 9 AM
        attendanceData.push({
          id: 'att_' + Date.now(),
          username: username,
          fullName: localStorage.getItem('fullName') || username,
          date: today,
          checkIn: now,
          status: isLate ? 'late' : 'present'
        });
      }
      
      localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
      loadAttendanceData();
      alert(existingRecord ? 'Check out marked successfully!' : 'Check in marked successfully!');
    }

    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
  <style>
    .leave-balance-item {
      margin-bottom: 16px;
    }
    .leave-type-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .leave-type-name {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .leave-days {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .progress-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    .leave-request-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .request-info h4 {
      margin: 0 0 4px 0;
      font-size: 1rem;
    }
    .leave-type-badge {
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .approval-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .request-details {
      display: grid;
      gap: 8px;
    }
    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .detail-item i {
      width: 16px;
      color: var(--primary);
    }
    .attendance-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-item {
      text-align: center;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .attendance-month {
      margin-bottom: 24px;
    }
    .attendance-month h4 {
      margin: 0 0 12px 0;
      color: var(--text);
    }
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }
    .attendance-day {
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 0.8rem;
      border: 1px solid var(--border);
    }
    .attendance-day.success {
      background: #dcfce7;
      border-color: #16a34a;
    }
    .attendance-day.danger {
      background: #fee2e2;
      border-color: #ef4444;
    }
    .attendance-day.warning {
      background: #fef3c7;
      border-color: #f59e0b;
    }
    .day-date {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .day-status {
      font-size: 0.7rem;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    .day-time {
      font-size: 0.7rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1><i class="fas fa-calendar-alt"></i> Leave & Attendance Management</h1>
      <div class="user-info">
        <span id="currentUser">Loading...</span>
        <button onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
  </header>
  
  <div class="container">
    <nav class="sidebar">
      <div class="sidebar-header"><i class="fas fa-user-tie"></i><span>Portal</span></div>
      <ul class="nav-links">
        <li><a href="employee-dashboard.html"><i class="fas fa-gauge"></i><span>Dashboard</span></a></li>
        <li><a href="employee-profile.html"><i class="fas fa-user-cog"></i><span>Profile</span></a></li>
        <li class="active"><a href="leave-management.html"><i class="fas fa-calendar-alt"></i><span>Leave & Attendance</span></a></li>
        <li><a href="time-tracking.html"><i class="fas fa-clock"></i><span>Time Tracking</span></a></li>
        <li><a href="employee-directory.html"><i class="fas fa-users"></i><span>Directory</span></a></li>
        <li><a href="crypto-payroll.html"><i class="fas fa-coins"></i><span>Crypto Payroll</span></a></li>
      </ul>
    </nav>
    
    <main class="main-content">
      <!-- Leave Balance Section -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-chart-pie"></i> Leave Balance</h3>
        </div>
        <div id="leaveBalance"></div>
      </div>

      <!-- Attendance Summary -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-chart-bar"></i> Attendance Summary (This Month)</h3>
          <button onclick="markAttendance()" class="primary-btn">
            <i class="fas fa-clock"></i> Mark Attendance
          </button>
        </div>
        <div id="attendanceSummary"></div>
      </div>

      <!-- Leave Requests -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-file-alt"></i> Leave Requests</h3>
          <button onclick="openLeaveRequestModal()" class="primary-btn">
            <i class="fas fa-plus"></i> Request Leave
          </button>
        </div>
        <div id="leaveRequests"></div>
      </div>

      <!-- Attendance History -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-history"></i> Attendance History</h3>
        </div>
        <div id="attendanceHistory"></div>
      </div>
    </main>
  </div>

  <!-- Leave Request Modal -->
  <div id="leaveRequestModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-calendar-plus"></i> Request Leave</h3>
        <span class="close" onclick="closeLeaveRequestModal()">&times;</span>
      </div>
      <form id="leaveRequestForm" onsubmit="submitLeaveRequest(event)">
        <div class="form-grid">
          <div class="form-group">
            <label>Leave Type</label>
            <select name="leaveType" required>
              <option value="">Select leave type...</option>
              <option value="sick">Sick Leave</option>
              <option value="vacation">Vacation Leave</option>
              <option value="personal">Personal Leave</option>
              <option value="emergency">Emergency Leave</option>
              <option value="maternity">Maternity Leave</option>
              <option value="paternity">Paternity Leave</option>
            </select>
          </div>
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" name="startDate" required>
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" name="endDate" required>
          </div>
          <div class="form-group">
            <label>Reason</label>
            <textarea name="reason" rows="3" placeholder="Please provide a reason for your leave request..."></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="secondary-btn" onclick="closeLeaveRequestModal()">Cancel</button>
          <button type="submit" class="primary-btn"><i class="fas fa-paper-plane"></i> Submit Request</button>
        </div>
      </form>
    </div>
  </div>

  <footer><p>&copy; 2025 PayrollPro by Aaron | Leave & Attendance Management</p></footer>
</body>
</html>