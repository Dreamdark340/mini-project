<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payroll Calendar - Payroll Management</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    function logout(){ localStorage.removeItem('authToken'); localStorage.removeItem('userRole'); localStorage.removeItem('username'); localStorage.removeItem('fullName'); window.location.href='login.html'; }
    function checkAuth(){ const t=localStorage.getItem('authToken'); const r=localStorage.getItem('userRole'); const u=localStorage.getItem('username'); if(!t||!r||!u){ window.location.href='login.html'; return; } if(r!=='hr' && r!=='admin'){ alert('HR/Admin access required'); window.location.href='login.html'; return; } document.getElementById('currentUser').innerHTML=`<span>${localStorage.getItem('fullName') || u}</span><span class="role-badge">${r.toUpperCase()}</span>`; document.body.classList.add('employee-theme'); loadPayrollCalendar(); }
    
    let currentDate = new Date();
    let currentView = 'month';
    let payrollCycles = [];
    
    function loadPayrollCalendar() {
        generatePayrollCycles();
        displayCalendar();
        loadPayrollStatus();
        setupCutoffReminders();
    }
    
    function generatePayrollCycles() {
        const cycles = JSON.parse(localStorage.getItem('payrollCycles') || '[]');
        if (cycles.length === 0) {
            const demoCycles = [];
            const today = new Date();
            
            // Generate cycles for the past 6 months and next 6 months
            for (let i = -6; i <= 6; i++) {
                const month = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const cutoffDate = new Date(month.getFullYear(), month.getMonth(), 25); // 25th of each month
                const payDate = new Date(month.getFullYear(), month.getMonth() + 1, 5); // 5th of next month
                
                demoCycles.push({
                    id: `cycle_${month.getFullYear()}_${month.getMonth()}`,
                    month: month.toISOString().split('T')[0],
                    cutoffDate: cutoffDate.toISOString().split('T')[0],
                    payDate: payDate.toISOString().split('T')[0],
                    status: getCycleStatus(cutoffDate, payDate),
                    employeeCount: 8,
                    totalAmount: 45000,
                    processedBy: i < 0 ? 'hr1' : null,
                    processedDate: i < 0 ? new Date(cutoffDate.getTime() + 86400000).toISOString().split('T')[0] : null
                });
            }
            
            localStorage.setItem('payrollCycles', JSON.stringify(demoCycles));
            payrollCycles = demoCycles;
        } else {
            payrollCycles = cycles;
        }
    }
    
    function getCycleStatus(cutoffDate, payDate) {
        const today = new Date();
        if (today < cutoffDate) return 'upcoming';
        if (today >= cutoffDate && today < payDate) return 'processing';
        if (today >= payDate) return 'completed';
        return 'upcoming';
    }
    
    function displayCalendar() {
        const calendarContainer = document.getElementById('calendarContainer');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        const calendarHTML = `
            <div class="calendar-header">
                <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3>${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid">
                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                    <div class="day-header">${day}</div>
                `).join('')}
                ${Array.from({length: 42}, (_, i) => {
                    const dayDate = new Date(startDate);
                    dayDate.setDate(startDate.getDate() + i);
                    const isCurrentMonth = dayDate.getMonth() === month;
                    const isToday = dayDate.toDateString() === new Date().toDateString();
                    const cycleInfo = getCycleInfoForDate(dayDate);
                    
                    return `
                        <div class="day-cell ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${cycleInfo ? `cycle-${cycleInfo.type}` : ''}">
                            <div class="day-number">${dayDate.getDate()}</div>
                            ${cycleInfo ? `
                                <div class="cycle-indicator ${cycleInfo.type}">
                                    <i class="${cycleInfo.icon}"></i>
                                    <span>${cycleInfo.label}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        calendarContainer.innerHTML = calendarHTML;
    }
    
    function getCycleInfoForDate(date) {
        const dateStr = date.toISOString().split('T')[0];
        const cycle = payrollCycles.find(c => c.cutoffDate === dateStr || c.payDate === dateStr);
        
        if (!cycle) return null;
        
        if (dateStr === cycle.cutoffDate) {
            return {
                type: 'cutoff',
                icon: 'fas fa-calendar-times',
                label: 'Cutoff'
            };
        }
        
        if (dateStr === cycle.payDate) {
            return {
                type: 'payday',
                icon: 'fas fa-money-bill-wave',
                label: 'Pay Day'
            };
        }
        
        return null;
    }
    
    function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        displayCalendar();
        loadPayrollStatus();
    }
    
    function loadPayrollStatus() {
        const currentMonth = currentDate.toISOString().substring(0, 7);
        const currentCycle = payrollCycles.find(c => c.month.startsWith(currentMonth));
        
        if (currentCycle) {
            document.getElementById('currentStatus').textContent = currentCycle.status.toUpperCase();
            document.getElementById('currentStatus').className = `status-badge ${getStatusClass(currentCycle.status)}`;
            document.getElementById('cutoffDate').textContent = new Date(currentCycle.cutoffDate).toLocaleDateString();
            document.getElementById('payDate').textContent = new Date(currentCycle.payDate).toLocaleDateString();
            document.getElementById('employeeCount').textContent = currentCycle.employeeCount;
            document.getElementById('totalAmount').textContent = `$${currentCycle.totalAmount.toLocaleString()}`;
            
            // Show/hide process button based on status
            const processBtn = document.getElementById('processPayrollBtn');
            if (currentCycle.status === 'upcoming' && new Date() >= new Date(currentCycle.cutoffDate)) {
                processBtn.style.display = 'inline-flex';
                processBtn.disabled = false;
            } else if (currentCycle.status === 'processing') {
                processBtn.style.display = 'inline-flex';
                processBtn.disabled = true;
                processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            } else {
                processBtn.style.display = 'none';
            }
        }
    }
    
    function getStatusClass(status) {
        switch(status) {
            case 'upcoming': return 'warning';
            case 'processing': return 'primary';
            case 'completed': return 'success';
            default: return 'secondary';
        }
    }
    
    function setupCutoffReminders() {
        const today = new Date();
        const upcomingCutoffs = payrollCycles.filter(cycle => {
            const cutoffDate = new Date(cycle.cutoffDate);
            const daysUntilCutoff = Math.ceil((cutoffDate - today) / (1000 * 60 * 60 * 24));
            return daysUntilCutoff >= 0 && daysUntilCutoff <= 7;
        });
        
        const remindersContainer = document.getElementById('cutoffReminders');
        if (upcomingCutoffs.length === 0) {
            remindersContainer.innerHTML = '<div class="no-data">No upcoming cutoffs</div>';
            return;
        }
        
        remindersContainer.innerHTML = upcomingCutoffs.map(cycle => {
            const cutoffDate = new Date(cycle.cutoffDate);
            const daysUntil = Math.ceil((cutoffDate - today) / (1000 * 60 * 60 * 24));
            
            return `
                <div class="reminder-card">
                    <div class="reminder-date">
                        <i class="fas fa-calendar-times"></i>
                        ${cutoffDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                    <div class="reminder-details">
                        <div class="reminder-period">${new Date(cycle.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>
                        <div class="reminder-countdown">${daysUntil === 0 ? 'Today' : `${daysUntil} day${daysUntil > 1 ? 's' : ''} left`}</div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function processPayroll() {
        if (!confirm('Process payroll for this cycle? This action cannot be undone.')) return;
        
        const currentMonth = currentDate.toISOString().substring(0, 7);
        const currentCycle = payrollCycles.find(c => c.month.startsWith(currentMonth));
        
        if (currentCycle) {
            currentCycle.status = 'processing';
            currentCycle.processedBy = localStorage.getItem('username');
            currentCycle.processedDate = new Date().toISOString().split('T')[0];
            
            localStorage.setItem('payrollCycles', JSON.stringify(payrollCycles));
            loadPayrollStatus();
            displayCalendar();
            
            // Simulate processing delay
            setTimeout(() => {
                currentCycle.status = 'completed';
                localStorage.setItem('payrollCycles', JSON.stringify(payrollCycles));
                loadPayrollStatus();
                displayCalendar();
                
                alert('Payroll processed successfully!');
            }, 3000);
        }
    }
    
    function viewPayrollHistory() {
        const historyContainer = document.getElementById('payrollHistoryContainer');
        const completedCycles = payrollCycles.filter(c => c.status === 'completed');
        
        if (completedCycles.length === 0) {
            historyContainer.innerHTML = '<div class="no-data">No completed payroll cycles</div>';
            return;
        }
        
        historyContainer.innerHTML = `
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Period</th>
                            <th>Cutoff Date</th>
                            <th>Pay Date</th>
                            <th>Employees</th>
                            <th>Total Amount</th>
                            <th>Processed By</th>
                            <th>Processed Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${completedCycles.map(cycle => `
                            <tr>
                                <td>${new Date(cycle.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
                                <td>${new Date(cycle.cutoffDate).toLocaleDateString()}</td>
                                <td>${new Date(cycle.payDate).toLocaleDateString()}</td>
                                <td>${cycle.employeeCount}</td>
                                <td>$${cycle.totalAmount.toLocaleString()}</td>
                                <td>${cycle.processedBy || '-'}</td>
                                <td>${cycle.processedDate ? new Date(cycle.processedDate).toLocaleDateString() : '-'}</td>
                                <td>
                                    <button class="secondary-btn small" onclick="viewPayrollDetails('${cycle.id}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="secondary-btn small" onclick="downloadPayrollReport('${cycle.id}')">
                                        <i class="fas fa-download"></i> Report
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    function viewPayrollDetails(cycleId) {
        const cycle = payrollCycles.find(c => c.id === cycleId);
        if (!cycle) return;
        
        alert(`Payroll details for ${new Date(cycle.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}:\n\nEmployees: ${cycle.employeeCount}\nTotal Amount: $${cycle.totalAmount.toLocaleString()}\nProcessed: ${cycle.processedDate ? new Date(cycle.processedDate).toLocaleDateString() : 'Not processed'}`);
    }
    
    function downloadPayrollReport(cycleId) {
        const cycle = payrollCycles.find(c => c.id === cycleId);
        if (!cycle) return;
        
        // Simulate PDF generation
        alert(`Generating payroll report for ${new Date(cycle.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}...\n\nReport includes:\n- Employee-wise salary breakdown\n- Tax deductions\n- Net pay calculations\n- Bank transfer details`);
    }
    
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
  <style>
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .calendar-header button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calendar-header button:hover {
      background: var(--primary-600);
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .day-header {
      background: var(--primary);
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: 600;
    }
    .day-cell {
      background: var(--card);
      min-height: 100px;
      padding: 8px;
      border: none;
      position: relative;
    }
    .day-cell.today {
      background: #e0f2fe;
    }
    .day-cell.other-month {
      background: #f5f5f5;
      color: #999;
    }
    .day-number {
      font-weight: 600;
      margin-bottom: 5px;
    }
    .cycle-indicator {
      position: absolute;
      bottom: 5px;
      left: 5px;
      right: 5px;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .cycle-indicator.cutoff {
      background: #f59e0b;
    }
    .cycle-indicator.payday {
      background: #10b981;
    }
    .status-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .status-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .status-card h4 {
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .status-card .value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }
    .reminders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .reminder-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: var(--shadow);
    }
    .reminder-date {
      background: #fef3c7;
      color: #92400e;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      min-width: 80px;
    }
    .reminder-details {
      flex: 1;
    }
    .reminder-period {
      font-weight: 600;
      margin-bottom: 5px;
    }
    .reminder-countdown {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .process-payroll-section {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
    }
    @media (max-width: 768px) {
      .calendar-grid {
        font-size: 0.8rem;
      }
      .day-cell {
        min-height: 80px;
      }
      .reminders-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <h1><i class="fas fa-calendar-alt"></i> Payroll Calendar</h1>
      <div class="user-info">
        <span id="currentUser">Loading...</span>
        <button onclick="logout()" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
  </header>
  
  <div class="container">
    <nav class="sidebar">
      <div class="sidebar-header"><i class="fas fa-user-tie"></i><span>HR Portal</span></div>
      <ul class="nav-links">
        <li><a href="hr-dashboard.html"><i class="fas fa-users"></i><span>HR Dashboard</span></a></li>
        <li><a href="employee-directory.html"><i class="fas fa-users"></i><span>Directory</span></a></li>
        <li><a href="performance-reviews.html"><i class="fas fa-chart-line"></i><span>Performance</span></a></li>
        <li><a href="audit-compliance.html"><i class="fas fa-shield-alt"></i><span>Audit</span></a></li>
        <li class="active"><a href="payroll-calendar.html"><i class="fas fa-calendar-alt"></i><span>Payroll Calendar</span></a></li>
      </ul>
    </nav>
    
    <main class="main-content">
      <div class="page-header">
        <h2><i class="fas fa-calendar-alt"></i> Payroll Calendar</h2>
        <p>Manage payroll cycles, cutoff dates, and processing schedules.</p>
      </div>
      
      <!-- Status Overview -->
      <div class="status-overview">
        <div class="status-card">
          <h4>Current Status</h4>
          <div class="status-badge" id="currentStatus">-</div>
        </div>
        <div class="status-card">
          <h4>Cutoff Date</h4>
          <div class="value" id="cutoffDate">-</div>
        </div>
        <div class="status-card">
          <h4>Pay Date</h4>
          <div class="value" id="payDate">-</div>
        </div>
        <div class="status-card">
          <h4>Employees</h4>
          <div class="value" id="employeeCount">-</div>
        </div>
        <div class="status-card">
          <h4>Total Amount</h4>
          <div class="value" id="totalAmount">-</div>
        </div>
      </div>
      
      <!-- Process Payroll Section -->
      <div class="process-payroll-section" id="processPayrollSection" style="display: none;">
        <h3><i class="fas fa-cogs"></i> Ready to Process Payroll</h3>
        <p>The cutoff date has passed. You can now process payroll for this cycle.</p>
        <button id="processPayrollBtn" class="primary-btn" onclick="processPayroll()">
          <i class="fas fa-play"></i> Process Payroll
        </button>
      </div>
      
      <!-- Cutoff Reminders -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-bell"></i> Upcoming Cutoffs</h3>
        </div>
        <div class="reminders-grid" id="cutoffReminders">
          <!-- Reminders will be populated here -->
        </div>
      </div>
      
      <!-- Calendar -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-calendar"></i> Payroll Calendar</h3>
          <p>Orange = Cutoff Date | Green = Pay Day</p>
        </div>
        <div id="calendarContainer">
          <!-- Calendar will be populated here -->
        </div>
      </div>
      
      <!-- Payroll History -->
      <div class="content-section">
        <div class="section-header">
          <h3><i class="fas fa-history"></i> Payroll History</h3>
          <button onclick="viewPayrollHistory()" class="secondary-btn">
            <i class="fas fa-refresh"></i> Refresh
          </button>
        </div>
        <div id="payrollHistoryContainer">
          <!-- History will be populated here -->
        </div>
      </div>
    </main>
  </div>
  
  <footer><p>&copy; 2025 PayrollPro by Aaron | Payroll Calendar</p></footer>
</body>
</html>